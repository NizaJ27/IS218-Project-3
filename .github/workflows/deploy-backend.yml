name: Deploy Backend

on:
  push:
    branches:
      - master
    paths:
      - 'projects/backend/**'
      - 'infrastructure/**'

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Notify deployment
        run: |
          echo "âœ… Changes pushed to master branch"
          echo "ğŸ”„ Server will auto-deploy within 5 minutes via cron job"
          echo "ğŸ“¦ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Pusher: ${{ github.actor }}"
      
      - name: Wait for auto-deployment window
        run: |
          echo "â³ Waiting 6 minutes for server to detect and deploy changes..."
          echo "   (Server checks for updates every 5 minutes)"
          sleep 360
      
      - name: Health check
        run: |
          echo "ğŸ¥ Checking if deployment succeeded..."
          
          # Check if API is responding
          status_code=$(curl -s -o /dev/null -w "%{http_code}" https://api.theratoast.com/health || echo "000")
          
          if [ "$status_code" = "200" ]; then
            echo "âœ… Health check passed (HTTP $status_code)"
            echo "âœ… Deployment appears successful!"
          else
            echo "âš ï¸  Health check returned HTTP $status_code"
            echo "âš ï¸  Deployment may need more time or manual verification"
          fi
